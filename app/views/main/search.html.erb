
<div id="header">
	<h1>Lyrebird for <%= @user.name %></h1>
	<input type="text" id="query" value= "<%= @user.search.blank? ? "Lyrebird" : @user.search %>" style="width: 250px;" />
	<input type="button" id="search" value="Search" />
	<input type="button" id="save" value="Retweet" />
	<br>
	<input type="checkbox" id="filter" />
	<select id="filter_type">
		<option value="exclude">Exclude all tweets from</option>
		<option value="include">Include only tweets from</option>
	</select>
	<input type="text" id="users" style="width: 180px;">
</div>
<%= javascript_tag "var AUTH_TOKEN = #{form_authenticity_token.inspect};" if protect_against_forgery? -%>
<script>
// Always send the authenticity_token with ajax
$(document).ajaxSend(function(event, request, settings) {
    if ( settings.type == 'post' ) {
        settings.data = (settings.data ? settings.data + "&" : "")
            + 'authenticity_token=' + encodeURIComponent( AUTH_TOKEN );
    }
});</script>
<div id="results" style="height: 400px; margin: auto;"></div>
<div id="status">
<h2>you are retweeting: <span id="nothing" style="color: gray; visibility: <%=@user.search.blank? ? 'visible' : 'hidden'  %> ">Nothing</span><a href="." id="tweeting"><%= @user.search %></a>
</h2></div>
<% if not @user.paid %>
<div id="controls">
  <%= render :partial => "paypal_button" %>
  <span id="trial">Trial: <%= @days_remaining %> day<%= "s" if @days_remaining != 1 %> remaining.
</div>
<% end %>
    <span style="float:right"><input type="button" id="stop" value="Stop Retweeting"  /></span>
<div style="text-align: center;"><%=link_to "Logout", :action => "logout" %></div>
   <script>
	$(document).ready(function(){
		$.ajaxSettings.accepts.html = $.ajaxSettings.accepts.script;
		searchNow();
		$("#search").click(function(event){
       		searchNow();
			event.preventDefault();
		});
		$("#query").keydown(function(event){
			if(event.which == 13)
				searchNow();
		});
		$("#tweeting").click(function(event){
      $("#query").val($(tweeting).html());
			searchNow();
      event.preventDefault();
    });
		$("#save").click(function(event){
		  saveSearch(generateSearch());
			event.preventDefault();
		});
		$("#stop").click(function(event){
			saveSearch("");
		});
  });
  
  function searchNow(){
  	$("#results").empty();
  	$("#results").twitterSearch({ 
  		term:   generateSearch(), 
  		bird:    false, 
  		colorExterior: 'white', 
  		colorInterior: 'white'
	  });
  }
  
  function generateSearch(){
	  var query = $("#query").val();
	  if($("#filter").is(":checked"))
	  {
      query += " " + splitlist();
	  }
	  return query;
	}
	function splitlist(){
	  var names = $("#users").val().split(",");
	  var include;
	  var result;
	  
	  if($("#filter_type").val() == "include")
	    include = true;
	  for(var i=0; i< names.length; i++){
	    names[i] =  (include ? "" : "-") + "from:" + names[i].trim();
	  }
	  return names.join((include) ? " OR " : " ");
	}
	function saveSearch(search){
	  $.ajax({
		url:"save",
		data: {
			user:"<%= @user.name %>",
			search: search
		},
		dataType: 'html',
		complete: function(retval){
			searchStr = jQuery.parseJSON(retval.responseText);
			$("#tweeting").html(searchStr.search);
			if(searchStr.search =="")
				$("#nothing").show();
			else
				$("#nothing").hide();
		  }
	  });
  }
    
   </script>